<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OC Reimbursement Tracker</title>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Roboto Condensed', Tahoma, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #4caf50;
      text-align: center;
      margin-bottom: 20px;
    }
    .card {
      background-color: #1e1e1e;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    label { display: block; margin: 10px 0; }
    input[type="password"], textarea {
      width: 100%; padding: 8px;
      border: 1px solid #444; border-radius: 4px;
      background-color: #222; color: #e0e0e0;
    }
    button {
      background-color: #333; color: #e0e0e0;
      border: 1px solid #555; padding: 8px 14px;
      border-radius: 4px; cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.2s, border-color 0.2s;
    }
    button:hover { background-color: #444; border-color: #888; }
    #status { font-weight: bold; margin: 10px 0; color: #ffa500; }
    textarea { height: 300px; background-color: #111; color: #e0e0e0; font-family: monospace; }
    .log-buy { color: #4caf50; }
    .log-send { color: #2196f3; }
    .log-pay { color: #ffd700; }
    .spinner {
      display: none; margin: 10px auto;
      border: 4px solid #333; border-top: 4px solid #4caf50;
      border-radius: 50%; width: 24px; height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
<script>
  var _paq = window._paq = window._paq || [];
  _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://analytics.modgaming.co.uk/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img referrerpolicy="no-referrer-when-downgrade" src="https://analytics.modgaming.co.uk/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>
</head>
<body>
  <h1>OC Reimbursement Tracker</h1>

  <div class="card">
    <label>üîë API Key:
      <input type="password" id="apiKey">
    </label>
    <label><input type="checkbox" id="remember"> Remember me</label>
    <label><input type="checkbox" id="ignoreCutoff"> Ignore cutoff</label>
    <button onclick="runTracker()">‚ñ∂ Run</button>
    <button onclick="clearCache()">üóëÔ∏è Clear Cache</button>
    <div id="status"></div>
    <div class="spinner" id="spinner"></div>
  </div>

  <div class="card">
    <h2>Output</h2>
    <textarea id="output"></textarea>
    <div style="margin-top:10px;">
      <button onclick="downloadLog()">‚¨á Download Log</button>
    </div>
  </div>

  <script>
    (function init() {
      const savedKey = localStorage.getItem("apiKey");
      if (savedKey) {
        document.getElementById("apiKey").value = savedKey;
        document.getElementById("remember").checked = true;
      }
    })();

    function formatTornTime(dateObj) {
      const hh = String(dateObj.getUTCHours()).padStart(2, '0');
      const mm = String(dateObj.getUTCMinutes()).padStart(2, '0');
      const ss = String(dateObj.getUTCSeconds()).padStart(2, '0');
      const dd = String(dateObj.getUTCDate()).padStart(2, '0');
      const MM = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
      const yy = String(dateObj.getUTCFullYear()).slice(-2);
      return `${hh}:${mm}:${ss} - ${dd}/${MM}/${yy}`;
    }

    function itemPhrase(name, qty) {
      if (qty === 1) {
        if (name && name.toLowerCase() === "zip ties") {
          return `some ${name}`;
        }
        return `a ${name}`;
      }
      return `${qty}x ${name}`;
    }

    async function runTracker() {
      let knownItems = JSON.parse(localStorage.getItem("knownItems") || "[]");
      let lastRun = localStorage.getItem("lastRun");

      const apiKey = document.getElementById("apiKey").value.trim();
      const remember = document.getElementById("remember").checked;
      const ignoreCutoff = document.getElementById("ignoreCutoff").checked;

      if (!apiKey) {
        document.getElementById("status").textContent = "‚ùå Please enter an API key.";
        return;
      }

      if (remember) localStorage.setItem("apiKey", apiKey);
      else localStorage.removeItem("apiKey");

      let cutoff;
      if (ignoreCutoff) {
        cutoff = null;
      } else if (lastRun) {
        cutoff = new Date(lastRun);
      } else {
        cutoff = null;
      }

      document.getElementById("status").textContent = "‚è≥ Fetching data‚Ä¶";
      document.getElementById("spinner").style.display = "block";

      try {
        const [logData, factionData, itemData, knownFile] = await Promise.all([
          fetch(`https://api.torn.com/user/?selections=log&key=${apiKey}`).then(r => r.json()),
          fetch(`https://api.torn.com/faction/?selections=basic&key=${apiKey}`).then(r => r.json()),
          fetch(`https://api.torn.com/torn/?selections=items&key=${apiKey}`).then(r => r.json()),
          fetch("https://modgaming.co.uk/ocrt/known_oc_items.txt").then(r => r.text()).catch(() => "")
        ]);

        if (logData.error || factionData.error || itemData.error) {
          document.getElementById("status").textContent = "‚ùå Torn API error.";
          document.getElementById("output").value =
            JSON.stringify({ logData, factionData, itemData }, null, 2);
          document.getElementById("spinner").style.display = "none";
          return;
        }

        // Merge hosted known items
        const hostedItems = knownFile.split(/\r?\n/).map(x => x.trim()).filter(x => x.length > 0);
        knownItems = Array.from(new Set([...knownItems, ...hostedItems]));

        const factionMemberIds = Object.keys(factionData.members || {}).map(id => String(id));
        const sentForOC = {};
        let totalCost = 0;
        let totalReimbursed = 0;
        let logLines = [];

        for (const entry of Object.values(logData.log || {})) {
          const timestamp = entry.timestamp * 1000;
          const isoTime = new Date(timestamp);
          if (cutoff && isoTime < cutoff) continue;

          const timeFmt = formatTornTime(isoTime);
          const title = entry.title;

          if (title === "Item send") {
            const receiverId = String(entry.data.receiver ?? entry.data.receiver_id ?? entry.data.user ?? "");
            for (const item of entry.data.items || []) {
              const name = itemData.items[item.id]?.name;
              if (!name) continue;
              const qty = item.qty || 1;
              if (receiverId && factionMemberIds.includes(receiverId)) {
                const receiverName = await getPlayerName(apiKey, receiverId);
                const phrase = itemPhrase(name, qty);
                logLines.push(
                  `<span class="log-send">${timeFmt} You sent ${phrase} to ${receiverName} with the message: ${entry.data.message}</span>`
                );
                sentForOC[name] = true;

                // If item is in hosted known list, always include it regardless of message
                if (knownItems.includes(name)) {
                  sentForOC[name] = true;
                }

                // Keep existing "For OC." logic too
                if (String(entry.data.message).trim() === "For OC." && !knownItems.includes(name)) {
                  knownItems.push(name);
                }
              }
            }
          }

          if (title === "Item market buy") {
            for (const item of entry.data.items || []) {
              const name = itemData.items[item.id]?.name;
              if (!name) continue;
              const qty = item.qty || 1;

              const include =
                ignoreCutoff ||
                !cutoff ||
                (knownItems.includes(name) && (sentForOC[name] || true));

              if (include) {
                totalCost += entry.data.cost_total;
                const sellerId = String(entry.data.seller ?? entry.data.seller_id ?? "");
                const sellerName = await getPlayerName(apiKey, sellerId || entry.data.seller);
                const eachPrice = Math.round(entry.data.cost_total / qty);
                const phrase = itemPhrase(name, qty);
                logLines.push(
                  `<span class="log-buy">${timeFmt} You bought ${phrase} on the item market from ${sellerName} at $${eachPrice} each for a total of $${entry.data.cost_total}</span>`
                );
              }
            }
          }

          if (title === "Faction payday receive") {
            const amt = entry.data.money_given;
            totalReimbursed += amt;
            logLines.push(
              `<span class="log-pay">${timeFmt} You paid $${amt} to hoggson from The ZOO</span>`
            );
          }
        }

        const summaryLines = [];
        summaryLines.push(`Total OC item purchases: $${totalCost}`);
        summaryLines.push(`Reimbursements received: $${totalReimbursed}`);
        if (totalCost === 0 && totalReimbursed === 0) {
          summaryLines.push("No OC purchases or reimbursements found.");
        } else if (totalReimbursed >= totalCost) {
          summaryLines.push("Reimbursement complete.");
        } else {
          summaryLines.push(
            `Reimbursement incomplete ‚Äî you still need to send yourself $${totalCost - totalReimbursed}`
          );
        }

        const finalOutput = logLines.reverse().concat(summaryLines);

        localStorage.setItem("knownItems", JSON.stringify(knownItems));
        const runTime = new Date().toISOString();
        localStorage.setItem("lastRun", runTime);

        document.getElementById("status").textContent = "‚úÖ Done.";
        document.getElementById("spinner").style.display = "none";

        document.getElementById("output").value = finalOutput
          .join("\n")
          .replace(/<[^>]+>/g, "");
      } catch (err) {
        document.getElementById("status").textContent = "‚ùå Network or fetch error.";
        document.getElementById("spinner").style.display = "none";
        document.getElementById("output").value = err.message;
      }
    }

    async function getPlayerName(apiKey, id) {
      try {
        const res = await fetch(
          `https://api.torn.com/user/${id}?selections=basic&key=${apiKey}`
        );
        const data = await res.json();
        return data.name || id;
      } catch {
        return id;
      }
    }

    function downloadLog() {
      const text = document.getElementById("output").value;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "oc_reimbursement_log.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearCache() {
      localStorage.removeItem("knownItems");
      localStorage.removeItem("lastRun");
      localStorage.removeItem("apiKey");

      document.getElementById("apiKey").value = "";
      document.getElementById("remember").checked = false;
      document.getElementById("ignoreCutoff").checked = false;

      document.getElementById("output").value = "";
      document.getElementById("status").textContent =
        "üóëÔ∏è Cache cleared. Next run will behave like a first run.";
    }
  </script>
</body>
</html>
